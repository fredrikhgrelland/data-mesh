---
- hosts: all
  become: yes
  vars:
    bootstraptimeout: 900
  tasks:
    - name: restart consul
      systemd:
        name: consul
        state: restarted
    - name: restart nomad
      systemd:
        name: nomad
        state: restarted
    - name: wait for consul to come up
      uri:
        url: "http://localhost:8500/v1/catalog/nodes"
        status_code: 200
      register: result
      until: result.status == 200
      retries: 60
      delay: 1
    - name: wait for nomad to come up
      uri:
        url: "http://127.0.0.1:4646/v1/jobs"
        status_code: 200
      register: result
      until: result.status == 200
      retries: 60
      delay: 3

    - name: Terraform
      terraform:
        project_path: ../terraform
        force_init: true
        state: present
      register: terraform

    - name: Terraform stdout
      debug:
        msg: "{{terraform.stdout}}"

    - name: Test healthchecks of services
      include_tasks: test.yml
      # variable mode setup via extra_args in Vagrant.ansible_local or bash -> ANSIBLE_ARGS='--extra-vars "mode=test"' vagrant up --provision
      when: mode == "test"